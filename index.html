<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromecast Test File</title>
    
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    
    <style>
        body { 
            font-family: sans-serif; 
            text-align: center; 
            margin-top: 50px; 
            background-color: #f0f2f5;
            color: #333;
        }

        h1, h2 {
            color: #2c3e50;
        }
        
        #custom-cast-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease;
        }

        #custom-cast-button:hover {
            transform: scale(1.1);
        }

        #custom-cast-button svg {
            width: 100%;
            height: 100%;
        }

        #cast-status-message {
            margin-top: 10px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        #cast-icon-off {
            fill: none;
            stroke: #34495e;
        }

        #cast-icon-on {
            fill: #3498db;
            stroke: none;
        }

        #custom-cast-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <h1>Radio Als Chromecast</h1>
    <h2>Testing Facility Attempt 12xe1.unckat</h2>

    <google-cast-launcher></google-cast-launcher>

    <audio controls autoplay>
        <source src="https://stream.classicpop.dk/radioals" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="cast-button-container">
        <button id="custom-cast-button">
            <svg id="cast-icon-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 16.1A5 5 0 0 1 5.9 11M2 12.05A9 9 0 0 1 9.95 3M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"/>
                <line x1="2" y1="20" x2="2.01" y2="20"/>
            </svg>
            <svg id="cast-icon-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                 <path d="M2 16.1A5 5 0 0 1 5.9 11M2 12.05A9 9 0 0 1 9.95 3M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"/>
                 <line x1="2" y1="20" x2="2.01" y2="20"/>
                 <path d="M22 6V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2"/>
                 <line x1="16" y1="20" x2="16" y2="20"/>
            </svg>
        </button>
        <div id="cast-status-message" style="display: none;"></div>
    </div>
    
    <p>Click the cast button to stream a test audio file.</p>
    
    <script>
        let currentSession = null;
        let isCasting = false;

        function onError(error) {
            console.error('Cast API error:', error);
        }

        window.__onGCastApiAvailable = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            } else {
                console.error("Google Cast API is not available.");
            }
        };

        function initializeCastApi() {
            const customCastButton = document.getElementById('custom-cast-button');
            const castStatusMessage = document.getElementById('cast-status-message');
            const castIconOff = document.getElementById('cast-icon-off');
            const castIconOn = document.getElementById('cast-icon-on');
            
            const sessionRequest = new chrome.cast.SessionRequest(chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID);
            const apiConfig = new chrome.cast.ApiConfig(
                sessionRequest,
                onSessionSuccess,
                onReceiverListener,
                chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED
            );

            chrome.cast.initialize(apiConfig, onInitSuccess, onError);

            customCastButton.addEventListener('click', () => {
                if (isCasting) {
                    currentSession.stop(() => {
                        console.log("Session stopped.");
                    }, onError);
                } else {
                    chrome.cast.requestSession(onSessionSuccess, onError);
                }
            });

            function onInitSuccess() {
                console.log('Cast API initialized successfully!');
            }
            
            function onSessionSuccess(session) {
                console.log('Session started:', session);
                currentSession = session;
                isCasting = true;
                updateCastButton();
                currentSession.addUpdateListener(sessionUpdateListener);
                
                // Pause local audio when casting starts
                var audioElem = document.querySelector('audio');
                if (audioElem && !audioElem.paused) {
                    audioElem.pause();
                }
                
                loadMedia();
            }

            function sessionUpdateListener(isAlive) {
                if (!isAlive) {
                    isCasting = false;
                    currentSession = null;
                    updateCastButton();
                }
            }

            function onReceiverListener(availability) {
                if (availability === chrome.cast.ReceiverAvailability.AVAILABLE) {
                    console.log('Chromecast receivers are available.');
                    castStatusMessage.style.display = 'none';
                    customCastButton.disabled = false;
                } else {
                    console.log('No Chromecast receivers found.');
                    castStatusMessage.style.display = 'block';
                    castStatusMessage.textContent = 'No Chromecast devices found on your network.';
                    customCastButton.disabled = true;
                }
            }
            
            function updateCastButton() {
                if (isCasting) {
                    castIconOff.style.display = 'none';
                    castIconOn.style.display = 'block';
                } else {
                    castIconOff.style.display = 'block';
                    castIconOn.style.display = 'none';
                }
            }
        }

        function loadMedia() {
            if (currentSession) {
                const mediaInfo = new chrome.cast.media.MediaInfo('https://stream.maxpop.dk/radioals', 'audio/mpeg');
                mediaInfo.streamType = chrome.cast.media.StreamType.LIVE;
                mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
                mediaInfo.metadata.title = 'Radio Als';
                mediaInfo.metadata.images = [new chrome.cast.Image('https://radioals.dk/onewebmedia/RadioAls_Favicon.png')];
                
                const request = new chrome.cast.media.LoadRequest(mediaInfo);
                
                currentSession.loadMedia(request, onMediaSuccess, onError);
            }
        }

        // New onMediaSuccess function to handle a live stream correctly
        function onMediaSuccess(mediaSession) {
            console.log('Test stream loaded successfully.');
            
            // Add a listener to the media session to handle state changes
            mediaSession.addUpdateListener(() => {
                // If the player state is LOADING and we are not casting, try to play.
                // This is a robust way to "kickstart" the playback.
                if (mediaSession.playerState === chrome.cast.media.PlayerState.PLAYING) {
                    console.log('Stream is now playing.');
                    // We can remove the listener now that it's playing.
                    mediaSession.removeUpdateListener(this);
                } else if (mediaSession.playerState === chrome.cast.media.PlayerState.PAUSED) {
                    // If it pauses right after loading, play it.
                    console.log('Stream paused unexpectedly, sending play command.');
                    mediaSession.play(null, () => {}, onError);
                }
            });
        }

        // Try to autoplay audio on page load
        window.addEventListener('DOMContentLoaded', function() {
            var audioElem = document.querySelector('audio');
            if (audioElem) {
                audioElem.play().catch(function(e) {
                    console.log('Autoplay was prevented:', e);
                });

                // Make the stream "unpausable"
                let wasPausedByUser = false;
                audioElem.addEventListener('pause', function() {
                    // Mark that the user paused
                    wasPausedByUser = true;
                });

                audioElem.addEventListener('play', function() {
                    if (wasPausedByUser) {
                        // Reload the stream to jump to live
                        audioElem.src = audioElem.querySelector('source').src;
                        audioElem.load();
                        audioElem.play().catch(function(e) {
                            console.log('Autoplay was prevented after reload:', e);
                        });
                        wasPausedByUser = false;
                    }
                });
            }
        });
    </script>
</body>
</html>