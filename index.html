<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chromecast Test File</title>
    
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    
    <style>
        body { 
            font-family: sans-serif; 
            text-align: center; 
            margin-top: 50px; 
            background-color: #f0f2f5;
            color: #333;
        }

        h1, h2 {
            color: #2c3e50;
        }
        
        #custom-cast-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease;
        }

        #custom-cast-button:hover {
            transform: scale(1.1);
        }

        #custom-cast-button svg {
            width: 100%;
            height: 100%;
        }

        #cast-status-message {
            margin-top: 10px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        #cast-icon-off {
            fill: none;
            stroke: #34495e;
        }

        #cast-icon-on {
            fill: #3498db;
            stroke: none;
        }

        #custom-cast-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <h1>Chromecast Test File</h1>
    <h2>Audio Stream Test</h2>

    <div id="cast-button-container">
        <button id="custom-cast-button">
            <svg id="cast-icon-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 16.1A5 5 0 0 1 5.9 11M2 12.05A9 9 0 0 1 9.95 3M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"/>
                <line x1="2" y1="20" x2="2.01" y2="20"/>
            </svg>
            <svg id="cast-icon-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                 <path d="M2 16.1A5 5 0 0 1 5.9 11M2 12.05A9 9 0 0 1 9.95 3M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"/>
                 <line x1="2" y1="20" x2="2.01" y2="20"/>
                 <path d="M22 6V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2"/>
                 <line x1="16" y1="20" x2="16" y2="20"/>
            </svg>
        </button>
        <div id="cast-status-message" style="display: none;"></div>
    </div>
    
    <p>Click the cast button to stream a test audio file.</p>
    
    <script>
        window.__onGCastApiAvailable = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            } else {
                console.error("Google Cast API is not available.");
            }
        };

        function initializeCastApi() {
            // Check if the modern framework API is available
            if (typeof cast !== 'undefined' && cast.framework && cast.framework.CastContext) {
                const context = cast.framework.CastContext.getInstance();
                const options = new cast.framework.CastOptions();
                options.receiverApplicationId = chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID;
                context.setOptions(options);

                const customCastButton = document.getElementById('custom-cast-button');
                const castStatusMessage = document.getElementById('cast-status-message');
                const castIconOff = document.getElementById('cast-icon-off');
                const castIconOn = document.getElementById('cast-icon-on');
                
                customCastButton.addEventListener('click', () => {
                    context.requestSession();
                });

                function updateCastButton() {
                    const castState = context.getCastState();
                    const deviceState = context.getDeviceState();
                    
                    if (castState === cast.framework.CastState.CONNECTED) {
                        console.log('Successfully connected to a Chromecast device!');
                        castIconOff.style.display = 'none';
                        castIconOn.style.display = 'block';
                        castStatusMessage.style.display = 'none';
                        customCastButton.disabled = false;
                        loadMedia();
                    } else {
                        castIconOff.style.display = 'block';
                        castIconOn.style.display = 'none';
                        if (deviceState === cast.framework.DeviceState.NO_DEVICES_AVAILABLE) {
                            console.log('No Chromecast devices found on your network.');
                            castStatusMessage.style.display = 'block';
                            castStatusMessage.textContent = 'No Chromecast devices found on your network.';
                            customCastButton.disabled = true;
                        } else if (deviceState === cast.framework.DeviceState.AVAILABLE) {
                            castStatusMessage.style.display = 'none';
                            customCastButton.disabled = false;
                        } else { 
                            castStatusMessage.style.display = 'none';
                            customCastButton.disabled = false;
                        }
                    }
                }
                
                context.addEventListener(cast.framework.CastContextEventType.STATE_CHANGED, function() {
                    updateCastButton();
                });

                updateCastButton();
            } else {
                // Fallback for older API versions
                console.error("Modern cast.framework API not available.");
                // We'll leave the button disabled and show a message in this case
                const castStatusMessage = document.getElementById('cast-status-message');
                const customCastButton = document.getElementById('custom-cast-button');
                customCastButton.disabled = true;
                castStatusMessage.style.display = 'block';
                castStatusMessage.textContent = 'Casting is not available on your browser. Please update to a modern version of Chrome.';
            }
        }

        function loadMedia() {
            if (typeof cast !== 'undefined' && cast.framework && cast.framework.CastContext) {
                const context = cast.framework.CastContext.getInstance();
                const session = context.getCurrentSession();
                
                if (session) {
                    const mediaInfo = new chrome.cast.media.MediaInfo('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
                    mediaInfo.streamType = chrome.cast.media.StreamType.BUFFERED;
                    mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
                    mediaInfo.metadata.title = 'SoundHelix Test Song';
                    mediaInfo.metadata.images = [new chrome.cast.Image('https://www.soundhelix.com/pub/logo.png')];
                    
                    const request = new chrome.cast.media.LoadRequest(mediaInfo);
                    
                    session.loadMedia(request).then(
                        function() {
                            console.log('Test stream loaded and playing successfully.');
                        },
                        function(errorCode) {
                            console.error('Error loading test media: ' + errorCode);
                        }
                    );
                }
            } else {
                console.error("Cannot load media. Modern cast API not available.");
            }
        }
    </script>
</body>
</html>